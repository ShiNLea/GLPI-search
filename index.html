<!DOCTYPE html>
<html>
    <head>
        <script src="jquery-3.7.0.min.js"></script>
        <title>GLPI Info Tool</title>
        <link rel="stylesheet" href="style.css">
    </head>
    <body>
        <h1>GLPI info grab (name and UX wip)</h1>
        <label for="sTag">Enter app token (found on GLPI API page):</label><br>
        <form>
            <input type="password" id="userToken" name="userToken" value="">
            <button type="button" id="get_Connection">Submit Token</button>
            <button type="button" id="kill_Connection" class="button button2">Kill Session</button><br><br>

            <input type="input" id="searchTerm" name="searchTerm" value="">
            <button type="button" id="search_By_Tag">Search</button>
        </form>

        <h2 id="infoHeader"></h2>
        <p id="serial"></p>
        <p id="manufacturer"></p>
        <p id="model"></p>
        <p id="cpu"></p>
        <p id="memory"></p>
        <p id="drive"></p>
        <!--Displaying grabbed info--> 
        <div id="tableSection">
            <table id="infoTable"></table><br>
        </div>       
             
    </body>
</html>

<!--Back End stuff-->
<!--
    This entails exactly what it says it is: stuff in the back end. It takes
    the inputted service tag, and uses that to talk to GLPI's API.
-->
<script>

    const getConnection = document.querySelector("#get_Connection");
    const killSession = document.querySelector("#kill_Connection");
    const tagLookup = document.querySelector("#search_By_Tag");

    var sessionToken
    getConnection.onclick = () => {establishConnection()};
    killSession.onclick = () => {killConnection(sessionToken)};
    tagLookup.onclick = () => {searchByTag(sessionToken)};


    function establishConnection() {
        const getToken = new Promise(function(resolve, reject) {
            let userToken = document.getElementById("userToken").value;
            let finalHeader = "user_token ".concat(userToken);
            $.ajax({
                type: 'GET',
                url: "https://glpi.bdli.local/glpi/apirest.php/initSession",
                data: {},
                crossDomain: true,
                
                beforeSend: function(xhr) {
                    xhr.setRequestHeader('Authorization', finalHeader);
                },
                success: function(data){
                    alert("Entry granted.")
                    console.log("session started");
                    document.getElementById("infoTable").innerHTML = "<tr><th>Serial</th><th>Manufacturer</th><th>Model</th><th>CPU</th><th>Memory</th><th>HDD</th></tr>";
                    document.getElementById("tableSection").innerHTML += '<button type="button" onclick="saveToCSV()">Export to CSV</button>'
                    resolve(data);
                } ,
                error: function(data) {
                    alert("Error occurred. Check the API key or blame Ryan for bad coding.")
                    console.log("error occurred")
                }
            })
        })
        getToken.then((token) => {
            sessionToken = token.session_token;
        })
        
    };
    // Killing the granted session token
    function killConnection(sessionToken){
        console.log("session killed")
        $.ajax({
            type: 'GET',
            url: "https://glpi.bdli.local/glpi/apirest.php/killSession",
            data: {},
            crossDomain: true,
            
            beforeSend: function(xhr) {
                xhr.setRequestHeader('Session-Token', sessionToken )
            },
            success: function(data){
                var json = data;
                console.log("Session killed")
                alert("Session killed. Resubmit API token to regain access.")
            }
        });
    }

    // Searching GLPI database for laptop based on serial ID
    function searchByTag(sessionToken){
        searchTerm = document.getElementById("searchTerm").value;
        if (searchTerm == "" || searchTerm == null) {
            alert("Enter a search term or blame Ryan for bad coding.")
        }
        else {
        $.ajax({
            type: 'GET',
            url: 'https://glpi.bdli.local/glpi/apirest.php/search/Computer?is_deleted=0&as_map=0&criteria[0][link]=AND&criteria[0][field]=1&criteria[0][searchtype]=contains&criteria[0][value]=' + searchTerm + '&search=Search&itemtype=Computer&forcedisplay[0]=2',
            data: {},
            crossDomain: true,
            
            beforeSend: function(xhr) {
                xhr.setRequestHeader('Session-Token', sessionToken )
                xhr.setRequestHeader('Authorization', document.getElementById("userToken").value)
            },
            success: function(data){
                var json = data;
                console.log("id: " + json.data[0]["2"]);
                getInfo(sessionToken, json.data[0]["2"]);
            }
        });
        }
    }

    // Grabbing the info for the chosen system via API endpoint
    function getInfo(sessionToken, itemID){
        itemID = itemID.toString(10);
        $.ajax({
            type: 'GET',
            url: "https://glpi.bdli.local/glpi/apirest.php/Computer/" + itemID + "?expand_dropdowns=true&with_devices=true",
            data: {},
            crossDomain: true,
            
            beforeSend: function(xhr) {
                xhr.setRequestHeader('Session-Token', sessionToken )
                xhr.setRequestHeader('Authorization', document.getElementById("userToken").value)
            },
            success: function(data){
                var json = data;
                displayInfo(data)
            }
        });
    }

    // Information Display Function //
    function displayInfo(data){
        var table = document.getElementById("infoTable");
        var row = table.insertRow(-1);


        // Pre-calling object keys for non-hardcoding purposes as the 
        // ID#s for each of the below is different and cannot be grabbed
        let driveKey = Object.keys(data._devices['Item_DeviceHardDrive']);
        let memKey = Object.keys(data._devices['Item_DeviceMemory']);
        let cpuKey = Object.keys(data._devices['Item_DeviceProcessor']);

        // Writing all the stuff that there's (probably) only one of
        document.getElementById("infoHeader").innerHTML = "Info"
        document.getElementById("serial").innerHTML = "Serial: " + data.serial;
        row.insertCell(0).innerHTML = data.serial;
        document.getElementById("manufacturer").innerHTML = "Manufacturer: " + data.manufacturers_id;
        row.insertCell(1).innerHTML = data.manufacturers_id;
        document.getElementById("model").innerHTML = "Model: " + data.computermodels_id;
        row.insertCell(2).innerHTML = data.computermodels_id;
        document.getElementById("cpu").innerHTML = "CPU: " + data._devices["Item_DeviceProcessor"][cpuKey]["deviceprocessors_id"];
        row.insertCell(3).innerHTML = data._devices["Item_DeviceProcessor"][cpuKey]["deviceprocessors_id"];

        // RAM Info Display //
        document.getElementById("memory").innerHTML = ""
        if(memKey.length > 1) {
            let memTotal = 0;
            for (var i = 0; i < memKey.length; i++){
                var currentMemSize = data._devices["Item_DeviceMemory"][memKey[i]]["size"];
                document.getElementById("memory").innerHTML += 
                "Memory " + (i+1) + ": " + currentMemSize + "mb<br>";
                memTotal += currentMemSize;
            }
            document.getElementById("memory").innerHTML += "Total memory: " + memTotal + "mb";
            row.insertCell(4).innerHTML = memTotal
        }
        else if (memKey.length == 1){
            document.getElementById("memory").innerHTML += 
            "Memory: " + data._devices["Item_DeviceMemory"][memKey]["size"];
            row.insertCell(4).innerHTML = data._devices["Item_DeviceMemory"][memKey]["size"]
        }
        else {
            row.insertCell(4).innerHTML = "N/A"
        }
        
        // HDD Info Display //
        document.getElementById("drive").innerHTML = data._devices["Item_DeviceHardDrive"][driveKey]["deviceharddrives_id"]
        row.insertCell(5).innerHTML = data._devices["Item_DeviceHardDrive"][driveKey]["deviceharddrives_id"];
    }

    function saveToCSV() {

        // Variable to store the final csv data
        var csv_data = [];

        // Get each row data
        var rows = document.getElementsByTagName('tr');
        for (var i = 0; i < rows.length; i++) {

            // Get each column data
            var cols = rows[i].querySelectorAll('td,th');

            // Stores each csv row data
            var csvrow = [];
            for (var j = 0; j < cols.length; j++) {

                // Get the text data of each cell
                // of a row and push it to csvrow
                csvrow.push(cols[j].innerHTML);
            }

            // Combine each column value with comma
            csv_data.push(csvrow.join(","));
        }

        // Combine each row data with new line character
        csv_data = csv_data.join('\n');

        // Call this function to download csv file 
        downloadCSVFile(csv_data);

    }

    function downloadCSVFile(csv_data) {

        // Create CSV file object and feed
        // our csv_data into it
        CSVFile = new Blob([csv_data], {
            type: "text/csv"
        });

        // Create to temporary link to initiate
        // download process
        var temp_link = document.createElement('a');

        // Download csv file
        temp_link.download = "newData.csv";
        var url = window.URL.createObjectURL(CSVFile);
        temp_link.href = url;

        temp_link.style.display = "none";
        document.body.appendChild(temp_link);

        // Automatically click the link to
        // trigger download
        temp_link.click();
        document.body.removeChild(temp_link);
    }
</script>
